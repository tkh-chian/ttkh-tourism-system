# 代码保护系统使用指南

## 🛡️ 系统概述

为了确保已经人工测试通过的功能代码不被意外覆盖，我们建立了完善的代码保护机制，包括：

1. **文件校验和保护**：自动计算和验证文件完整性
2. **自动备份系统**：每次保护文件时自动创建备份
3. **Git集成保护**：通过Git hooks防止意外提交
4. **版本控制保护**：完整的变更追踪和回滚机制

## 🚀 快速开始

### 1. 初始化保护系统
```bash
# 运行批处理文件（推荐）
保护核心文件.bat

# 或手动执行
node git-protection-setup.js
node code-protection-system.js protect-core
```

### 2. 验证系统状态
```bash
node code-protection-system.js verify
```

## 📋 主要命令

### 保护文件
```bash
# 保护单个文件
node code-protection-system.js protect <文件路径> [保护原因]

# 保护所有核心文件
node code-protection-system.js protect-core

# 示例
node code-protection-system.js protect frontend/src/components/OrderForm.tsx "订单功能测试通过"
```

### 验证文件完整性
```bash
# 验证所有受保护文件
node code-protection-system.js verify

# 检查特定文件
node code-protection-system.js check <文件路径>
```

### 恢复被修改的文件
```bash
# 恢复单个文件到受保护状态
node code-protection-system.js restore <文件路径>

# 示例
node code-protection-system.js restore frontend/src/components/OrderForm.tsx
```

### 生成保护报告
```bash
# 生成详细的保护状态报告
node code-protection-system.js report
```

## 🔧 核心功能

### 1. 文件保护机制

- **校验和计算**：使用MD5算法计算文件指纹
- **自动备份**：保护时自动创建带时间戳的备份文件
- **状态追踪**：记录保护时间、原因和文件状态

### 2. Git集成保护

- **Pre-commit Hook**：提交前自动验证受保护文件
- **分支保护**：主要分支需要代码审查
- **提交模板**：标准化的代码变更说明

### 3. 完整性验证

- **实时检查**：随时验证文件是否被修改
- **批量验证**：一次性检查所有受保护文件
- **详细报告**：显示文件状态和修改详情

## 📁 受保护的核心文件

### 前端核心组件
- `frontend/src/components/OrderForm.tsx` - 订单表单组件
- `frontend/src/pages/ProductDetail.tsx` - 产品详情页面
- `frontend/src/services/api.ts` - API服务层
- `frontend/src/contexts/AuthContext.tsx` - 认证上下文
- `frontend/src/pages/auth/Login.tsx` - 登录页面
- `frontend/src/pages/auth/Register.tsx` - 注册页面
- `frontend/src/App.tsx` - 主应用组件

### 后端核心文件
- `backend/simple-server-fixed.js` - 主服务器文件
- `backend/controllers/authController.js` - 认证控制器
- `backend/controllers/orderController.js` - 订单控制器
- `backend/controllers/productController.js` - 产品控制器
- `backend/routes/auth.js` - 认证路由
- `backend/routes/orders.js` - 订单路由
- `backend/routes/products.js` - 产品路由

### 数据库模型
- `backend/models/User.js` - 用户模型
- `backend/models/Product.js` - 产品模型
- `backend/models/Order.js` - 订单模型
- `backend/models/PriceSchedule.js` - 价格日历模型

## ⚠️ 重要注意事项

### 1. 修改受保护文件前
```bash
# 1. 先验证当前状态
node code-protection-system.js verify

# 2. 如需修改，先创建备份
node code-protection-system.js protect <文件路径> "修改前备份"

# 3. 进行修改

# 4. 测试通过后重新保护
node code-protection-system.js protect <文件路径> "修改后测试通过"
```

### 2. 发现文件被意外修改时
```bash
# 1. 查看修改详情
node code-protection-system.js verify

# 2. 恢复到受保护状态
node code-protection-system.js restore <文件路径>

# 3. 重新验证
node code-protection-system.js verify
```

### 3. 团队协作规范
- 修改受保护文件需要团队确认
- 使用标准的提交信息格式
- 定期运行保护报告检查系统状态

## 📊 状态图标说明

- ✅ **完整** - 文件未被修改，状态正常
- ⚠️ **已修改** - 文件已被修改，需要确认
- ❌ **缺失** - 文件不存在或无法访问
- 🛡️ **受保护** - 文件已被保护系统管理

## 🔄 工作流程

### 日常开发流程
1. 开发前运行 `node code-protection-system.js verify`
2. 进行开发工作
3. 测试功能
4. 如果测试通过，保护新的或修改的文件
5. 提交代码（自动触发保护验证）

### 紧急恢复流程
1. 发现问题后立即停止开发
2. 运行 `node code-protection-system.js verify` 查看状态
3. 使用 `restore` 命令恢复关键文件
4. 重新测试系统功能
5. 确认问题解决后继续开发

## 📞 技术支持

如果遇到保护系统相关问题：

1. 查看生成的保护报告
2. 检查 `.code-backups/` 目录中的备份文件
3. 查看 `.code-protection.json` 配置文件
4. 运行 `node code-protection-system.js help` 获取帮助

## 🎯 最佳实践

1. **定期验证**：每天开始工作前运行验证命令
2. **及时保护**：功能测试通过后立即保护相关文件
3. **详细记录**：保护文件时提供清晰的保护原因
4. **团队同步**：定期分享保护报告给团队成员
5. **备份管理**：定期清理过期的备份文件

通过遵循这些指南，可以确保项目的核心功能代码得到有效保护，避免意外的代码覆盖和功能丢失。